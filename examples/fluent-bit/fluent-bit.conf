[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020

[INPUT]
    Name              tail
    Path              /var/log/app/*.log
    Tag               app.security
    Parser            json
    DB                /var/log/flb_app.db
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On

[INPUT]
    Name              tail
    Path              /var/log/nginx/access.log
    Tag               nginx.access
    Parser            nginx
    DB                /var/log/flb_nginx.db

[FILTER]
    Name    command
    Match   app.*
    Command python3 /opt/redact.py --rules /opt/redaction-rules.yaml
    Keep_Field message
    Keep_Field @timestamp
    Keep_Field level

[FILTER]
    Name    command
    Match   nginx.*
    Command python3 /opt/redact.py --rules /opt/redaction-rules.yaml
    Keep_Field message
    Keep_Field @timestamp

[FILTER]
    Name modify
    Match *
    Add redacted_by fluent-bit-redactor
    Add redacted_timestamp ${time()}

[OUTPUT]
    Name            es
    Match           app.*
    Host            elasticsearch.local
    Port            9200
    Index           app-security-redacted
    Type            _doc
    HTTP_User       elastic
    HTTP_Passwd     ${ELASTIC_PASSWORD}
    Logstash_Format On
    Logstash_Prefix app-security
    Include_Tag_Key On
    Tag_Key         @tag

[OUTPUT]
    Name            es
    Match           nginx.*
    Host            elasticsearch.local
    Port            9200
    Index           nginx-access-redacted
    Type            _doc
    HTTP_User       elastic
    HTTP_Passwd     ${ELASTIC_PASSWORD}
    Logstash_Format On
    Logstash_Prefix nginx-access

[OUTPUT]
    Name  stdout
    Match *
    Format json_lines